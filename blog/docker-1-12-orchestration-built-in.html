<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Docker 1.12 orchestration built-in</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Docker 1.12 adds different new features around orchestration, scaling and deployment, in this article I am happy to share some tests I did with this version">
    <meta name="keywords" content="docker, release, swarm, cloud, orchestration, distributed system, docker captain">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/docker-1-12-orchestration-built-in">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>

    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
      <script>
            function advchecker() {
               document.getElementById('adv-sponsor').style.display = "block";
            }
      </script>
      <!--<div class="carbon-banner">-->
      <!--<script async style="display:none;" onerror="advchecker()" type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>-->
<!--</div>-->

<h1>Docker 1.12 orchestration built-in</h1>
<main>
    <p class="meta">20 Jun 2016 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Six minute read</span>
 · on <a href="/blog">Gianluca's blog</a></p>

<p style="display:none;" class="note" id="adv-sponsor">Hey! I see you use an adblocker as I do as
well! I use Carbon Adv to support this tiny website a network with developers
in mind. Please consider disabling the adblocker for this website to support my
work.</p>

    <article>
    <blockquote class="twitter-tweet tw-align-center" data-lang="en"><p lang="en" dir="ltr">Some
tests with Docker 1.12! <a href="https://t.co/budUOtMuBB">https://t.co/budUOtMuBB</a> <a href="https://twitter.com/hashtag/docker?src=hash">#docker</a> <a href="https://twitter.com/hashtag/DockerCon?src=hash">#DockerCon</a>
orchestration, swarm and services.</p>&mdash; Gianluca Arbezzano (@GianArb) <a href="https://twitter.com/GianArb/status/744977855277309953">June 20,
2016</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>During the DockerCon 2016 docker announced Docker 1.12 release.
One of the news stories around the new version is the orchestration system built directly
inside the engine, this feature allow us to use swarm
without installing it separately from outside, it’s now a feature provided by Docker directly.</p>

<p>Now we have a new set of commands that allow us to orchestrate containers
across a cluster.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker swarm
docker node
docker service</code></pre></figure>

<p>All these commands are focused on increasing our ability to orchestrate our
containers and also join them in services.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="c"># create swarm manager</span>
docker-machine create <span class="nt">-d</span> virtualbox sw1
<span class="nb">echo</span> <span class="s2">"sudo /etc/init.d/docker stop &amp;&amp; </span><span class="se">\</span><span class="s2">
    curl https://test.docker.com/builds/Linux/x86_64/docker-1.12.0-rc2.tgz | </span><span class="se">\</span><span class="s2">
    tar xzf - &amp;&amp; sudo mv docker/* /usr/local/bin &amp;&amp; </span><span class="se">\</span><span class="s2">
    rm -rf docker/ &amp;&amp; sudo /etc/init.d/docker start"</span> | <span class="se">\</span>
    docker-machine ssh sw1 sh -
docker-machine ssh sw1 docker swarm init

<span class="c"># create another swarm node</span>
docker-machine create <span class="nt">-d</span> virtualbox sw2
<span class="nb">echo</span> <span class="s2">"sudo /etc/init.d/docker stop &amp;&amp; </span><span class="se">\</span><span class="s2">
    curl https://test.docker.com/builds/Linux/x86_64/docker-1.12.0-rc2.tgz | </span><span class="se">\</span><span class="s2">
    tar xzf - &amp;&amp; sudo mv docker/* /usr/local/bin &amp;&amp; </span><span class="se">\</span><span class="s2">
    rm -rf docker/ &amp;&amp; sudo /etc/init.d/docker start"</span> | <span class="se">\</span>
    docker-machine ssh sw2 sh -
docker-machine ssh sw2 docker swarm <span class="nb">join</span> <span class="si">$(</span>docker-machine ip sw1<span class="si">)</span>:2377</code></pre></figure>

<p>another Captain wrote this script that I just updated to work
with the public Docker 1.12-rc2. We can use this script to create a cluster with
virtual box ready to be used.  After this script you can see the number of
workers and masters, in this case your one and one.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>docker node <span class="nb">ls</span></code></pre></figure>

<p>Docker 1.12 has a built-in set of primitive functions to orchestrate your containers just
like a summary. The main commands that you must run to create a cluster are</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">## On the master to start your cluster</span>
<span class="nv">$ </span>docker swarm init <span class="nt">--listen-addr</span> &lt;master-IP<span class="o">(</span>this ip<span class="o">)&gt;</span>:2377
<span class="c">## on each node to add it into the cluster</span>
<span class="nv">$ </span>docker swarm <span class="nb">join</span> &lt;master-ip&gt;:2377</code></pre></figure>

<p><img class="img-fluid" alt="Docker Swarm architecture" src="/img/posts/swarm_arch.png" /></p>

<p>If you are not confident with docker swarm this is the architecture, this graph
is provided by Docker Inc. and explains really well the design around this project.
The principal actors are managers and workers, managers are the brains of the
system, they dispatch schedules and remember services and containers. Workers
execute these commands.</p>

<p>The cluster is secure because each node has a proper TLS
identity and all communications are encrypted end to end by default with a
automatic key rotation in order to increase the security around the keys use in
the cluster.</p>

<p><a href="https://raft.github.io/">Raft</a> is the consensual protocol used to distribute
message around the cluster and check the number of nodes, it’s complex
algorithm but really interested I have in plan another article about it but the
offical site contains a lot of details about it.</p>

<p>We already saw the concept of services in docker-compose they are a single or a
group of containers to describe your ecosystem, you can scale a specific
service or orchestrate it across your cluster. It’s the same here, you don’t have
a specification file like compose at the moment but anyway you can run a bunch
of commands to create your service.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>docker service create <span class="nt">--name</span> helloworld <span class="nt">--replicas</span> 1 alpine ping docker.com</code></pre></figure>

<p>With this example we push up a new service helloworld. It has one container from
the alpine image and it pings docker.com site.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker service <span class="nb">ls</span></code></pre></figure>

<p>To watch all our services, we can also inspect a service</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker service inspect &lt;container_id&gt;</code></pre></figure>

<p>There is a new concept, when you run a service you are also creating a task,
this task represents the container/s under your service, in this case we have
just one task</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker service tasks helloworld</code></pre></figure>

<p>When you scale your service you are creating new tasks</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker service scale <span class="nv">helloworld</span><span class="o">=</span>10</code></pre></figure>

<p>Now you can see 10 tasks that are running and you can inspect one of them,
inside you can find the containerId and you can, for example, follow logs</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">22:17 <span class="nv">$ </span>docker inspect  6fhfse4it8lwzlsk1t5sd5jbk
<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"ID"</span>: <span class="s2">"6fhfse4it8lwzlsk1t5sd5jbk"</span>,
        <span class="s2">"Version"</span>: <span class="o">{</span>
            <span class="s2">"Index"</span>: 67
        <span class="o">}</span>,
        <span class="s2">"CreatedAt"</span>: <span class="s2">"2016-06-18T21:06:36.707664178Z"</span>,
        <span class="s2">"UpdatedAt"</span>: <span class="s2">"2016-06-18T21:06:39.241942781Z"</span>,
        <span class="s2">"Spec"</span>: <span class="o">{</span>
            <span class="s2">"ContainerSpec"</span>: <span class="o">{</span>
                <span class="s2">"Image"</span>: <span class="s2">"alpine"</span>,
                <span class="s2">"Args"</span>: <span class="o">[</span>
                    <span class="s2">"ping"</span>,
                    <span class="s2">"docker.com"</span>
                <span class="o">]</span>
            <span class="o">}</span>,
            <span class="s2">"Resources"</span>: <span class="o">{</span>
                <span class="s2">"Limits"</span>: <span class="o">{}</span>,
                <span class="s2">"Reservations"</span>: <span class="o">{}</span>
            <span class="o">}</span>,
            <span class="s2">"RestartPolicy"</span>: <span class="o">{</span>
                <span class="s2">"Condition"</span>: <span class="s2">"any"</span>,
                <span class="s2">"MaxAttempts"</span>: 0
            <span class="o">}</span>,
            <span class="s2">"Placement"</span>: <span class="o">{}</span>
        <span class="o">}</span>,
        <span class="s2">"ServiceID"</span>: <span class="s2">"24e0pojscuj2irvlxvx2baiid"</span>,
        <span class="s2">"Slot"</span>: 2,
        <span class="s2">"NodeID"</span>: <span class="s2">"55v4jjzf56mcwnhbwvn4cq1rs"</span>,
        <span class="s2">"Status"</span>: <span class="o">{</span>
            <span class="s2">"Timestamp"</span>: <span class="s2">"2016-06-18T21:06:36.7110425Z"</span>,
            <span class="s2">"State"</span>: <span class="s2">"running"</span>,
            <span class="s2">"Message"</span>: <span class="s2">"started"</span>,
            <span class="s2">"ContainerStatus"</span>: <span class="o">{</span>
                <span class="s2">"ContainerID"</span>: <span class="s2">"4ec69142e3e886098915140663737f4176c6de5afe9f2fad1f5b2439d8fc336d"</span>,
                <span class="s2">"PID"</span>: 3627
            <span class="o">}</span>
        <span class="o">}</span>,
        <span class="s2">"DesiredState"</span>: <span class="s2">"running"</span>
    <span class="o">}</span>
<span class="o">]</span>
22:17 <span class="nv">$ </span>docker logs <span class="nt">-f</span> 6fhfse4it8lwzlsk1t5sd5jbk</code></pre></figure>

<p>At this point it is a normal container and it’s running on your cluster.
Well I tried to explain the main concept around this big feature provided by
Docker 1.12, the last example is just to cover the DNS topic.</p>

<p>I created an application that serve an http server and print the current IP.
Each server has an internal load balancer that dispatches traffic in round robin
between the different tasks.
In this way it’s totally transparent, you can just
resolve your service with a normal URL, docker will do the rest for you.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$.</span> docker service create —-name micro —-replicas 10 —-publish 8000/tcp gianarb/micro</code></pre></figure>

<p><a href="https://github.com/gianarb/micro">Micro</a> is an application that exposes an
http server on port 8000 and print the current ip, now we have 10 tasks with
this service.
To grab the current entry point for our service we can inspect it
and search for this information:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$.</span> docker service inspect &lt;id-service&gt;

...
      <span class="s2">"Endpoint"</span>: <span class="o">{</span>
            <span class="s2">"Spec"</span>: <span class="o">{}</span>,
            <span class="s2">"Ports"</span>: <span class="o">[</span>
                <span class="o">{</span>
                    <span class="s2">"Protocol"</span>: <span class="s2">"tcp"</span>,
                    <span class="s2">"TargetPort"</span>: 8000,
                    <span class="s2">"PublishedPort"</span>: 30000
                <span class="o">}</span>
            <span class="o">]</span>,
            <span class="s2">"VirtualIPs"</span>: <span class="o">[</span>
                <span class="o">{</span>
                    <span class="s2">"NetworkID"</span>: <span class="s2">"890fivvc6od3pa4rxd281lobb"</span>,
                    <span class="s2">"Addr"</span>: <span class="s2">"10.255.0.5/16"</span>
                <span class="o">}</span>
            <span class="o">]</span>
       <span class="o">}</span>
...</code></pre></figure>

<p>In this case our published port is 3000, we can call <ip>:3000 to resolve our
service, if you try to do multi request you can see your IP chances because the
internal DNS is calling different containers.</ip></p>

<p>This is just an overview about the features but there are other powerful news
like DAB, stacks and how do an easy update of your containers, this could be
the topic around my next article. Please stay in touch follow me on
<a href="https://github.com/gianarb">Twitter</a> to chat and receive news about the next articles.</p>

<blockquote>
  <p>Thanks <a href="https://twitter.com/gpelly">@gpelly</a> for your review!</p>
</blockquote>

    </article>
</main>


      <small class="footer">Something weird with this website? <a href="https://github.com/gianarb/gianarb.github.com/issues/new" target="_blank">Let me know</a>.</small>

    </body>
</html>

